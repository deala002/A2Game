<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Meeting Timer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script>

    class subTask {
      constructor(name, hours, minutes, seconds){
        this.name = name;
        this.hours = hours;
        this.minutes = minutes;
        this.seconds = seconds;
      }

      returnName() {
        return this.name;
      }

      returnHours() {
        return this.hours;
      }

      returnMinutes() {
        return this.minutes;
      }

      returnSeconds() {
        return this.seconds;
      }
    }

    var timerInterval = setInterval(null, 0);
    var savedTime = 0;
    var originalTime = 0;
    var currentTime = 0;
    var numSubTasks = 1;
    var currentTask = 0;
    var paused = false;
    const taskNames = [];
    const taskTimes = [];

    //Initate the start time of the timer
    function initiateCountdown() 
    {
        //Clear previously running timer
        clearInterval(timerInterval);

        //Get current time to set as reference point
        var startpoint = new Date().getTime();

      //Ignore values in textboxes if timer is paused
      if(paused == true)
      {
      paused = false;
      timerInterval = setInterval(function () { countDown(savedTime, startpoint) }, 100);
      }
      else {
        for(var i=0; i<numSubTasks; i++)
        {
          //Get time to set to from input
          var minutesInput = document.getElementById("taskTime" + i.toString(10));
          var taskInput = document.getElementById("taskName" + i.toString(10));

          taskTimes[i] = 0;

          if(i!=0)
          {
            taskTimes[i] = taskTimes[i-1];
          }

          taskNames[i] = taskInput.value;

          //Set time to 0 if none is specified
          if (minutesInput.value != "")
          taskTimes[i] += JSON.parse(minutesInput.value);
          }

          //Calculate total time based of hours minutes and seconds 
          var totalOffset = taskTimes[numSubTasks-1] * 60000;

        //Initate countdown function from specified time
        if (totalOffset > 0) {
          originalTime = totalOffset;
          savedTime = totalOffset;
          timerInterval = setInterval(function () { countDown(totalOffset, startpoint) }, 100);
        }
        else //Initiate countdown function from last set time if no time is specified
          timerInterval = setInterval(function () { countDown(savedTime, startpoint) }, 100);
        
          //Display first task name in textbox
          var taskText = document.getElementById('taskName');
          taskText.innerHTML = taskNames[0];
        }
    }

    //Pause the countdown at current point
    function pauseCountdown() 
    {
      clearInterval(timerInterval);
      savedTime = currentTime;
      paused = true;
    }

    //Reset the countdown back to the originally specified time
    function resetCountdown() {
      clearInterval(timerInterval);

      savedTime = originalTime;
      currentTask = 0;

      var startpoint = new Date().getTime();
      countDown(originalTime, startpoint);
    }

    // Update count down each second
    function countDown(offset, startpoint) {
      // Update date and time to reference against original time
      var now = new Date().getTime();

      // Find the distance between now and reference date, adding in offset to count down from
      var distance = ((startpoint + offset) - now);
      currentTime = distance;

      var elapsedTime = (originalTime/60000) - (currentTime/60000);

      if(elapsedTime > taskTimes[currentTask])
      {
        currentTask++;
        var taskText = document.getElementById("taskName"); 
        taskText.innerHTML = taskNames[currentTask];
      }

      // Calculate hours, minutes and seconds
      var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
      var seconds = Math.floor((distance % (1000 * 60)) / 1000);

      // Display the result to screen
      document.getElementById("counter").innerHTML = hours + ":"
        + minutes + ":" + seconds;

      // Notify user if countdown complete
      if (distance < 0) {
        clearInterval(timerInterval);
        document.getElementById("counter").innerHTML = "00:00:00";
        taskText.innerHTML = "COMPLETE";

      }
    }

    function addTask(name, time)
    {
      numSubTasks++;
            
      // Retrieve the container tot add sub-tasks to
      var tasksContainer = document.getElementById("tasksContainer");
      
      // Create two input elements
      var lineBreak = document.createElement("br");
      var taskNameInput = document.createElement("input");
      var mInput = document.createElement("input");

      //set id of linebreak
      lineBreak.id = "break"+ (numSubTasks.toString(10)-1);

      //Set type, placeholder and id of taskNameInput
      taskNameInput.type = "Text";
      taskNameInput.placeholder = "Task name";
      taskNameInput.id = "taskName" + (numSubTasks.toString(10)-1);
      taskNameInput.value = name;

      //Set type, placeholder and id of timer
      mInput.type = "number";
      mInput.placeholder = "Minutes";
      mInput.id = "taskTime" + (numSubTasks.toString(10)-1);
      mInput.value = time;

      tasksContainer.appendChild(lineBreak);
      tasksContainer.appendChild(taskNameInput);
      tasksContainer.appendChild(mInput);
    }

    //import subtasks from a csv file
    function importSubTask(csvFile) 
    {
      //Remove all previously added tasks
      for(var i=0; i<numSubTasks; i++)
      {
        currentTaskName = document.getElementById("taskName" + i);
        currentTaskTime = document.getElementById("taskTime" + i);
        lineBreak = document.getElementById("break" + i);
        
        if(currentTaskName != null)
        currentTaskName.remove();

        if(currentTaskTime != null)
        currentTaskTime.remove();
        
        if(lineBreak != null)
        lineBreak.remove();

        //Update subtasks counter
        numSubTasks--;
      }

      //Read data in csv file
    let file = csvFile.files[0];
    var reader = new FileReader();
    reader.readAsText(file);

    reader.onload = function(event) 
    {
      var taskData = event.target.result;

      //Split data by each line
      var dataByRow = taskData.split('\n');

      //Split data in each line by commas
      for(var r=1; r<dataByRow.length-1; r++)
      {
        console.log(dataByRow);
        var taskDetails = dataByRow[r].split(',');

        //Catch error if an empty time is given
        try{
          addTask(taskDetails[0], JSON.parse(taskDetails[1]));
        }
        catch(syntaxError){
          numSubTasks--;
          console.log("CAUGHT: Empty line in CSV");
          addTask(taskDetails[0], 0);
        }
      }
    }
    }

    function exportSubTask() 
    {

    }

    function pauseSubTask() 
    {

    }

  </script>
</head>

<body>
  <h1>Meeting timer</h1>
  <p id="counter">00:00:00</p>
  <p id="taskName">No task</p>
  <div id="tasksContainer" class="center_div">
    <input type="text" placeholder="Task name" id="taskName0">
    <input type="number" placeholder="Minutes" id="taskTime0">

  </div>
    <button type="button" onclick="addTask('', 0)">Add Task</button>
  </div>
  <div class="center_div">
    <form>
      <button type="button" onclick="initiateCountdown()">Start</button>
      <button type="button" onclick="pauseCountdown()">Pause</button>
      <button type="button" onclick="resetCountdown()">Reset</button>
      <form>
        <input onchange="importSubTask(this)" type="file" id="csv-file-input" accept=".csv">
      </form>      
    </form>
  </div>
</body>
</html>