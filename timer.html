<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Meeting Timer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="programFiles/timerStyle.css" rel="stylesheet">

  <script>

    var stopwatchOffset = 0;
    var stopwatchTime = 0;
    var timerInterval = setInterval(null, 0);
    var statusDisplay;
    var savedTime = 0;
    var originalTime = 0;
    var currentTime = 0;
    var numSubTasks = 0;
    var currentTask = 0;

    var paused = false;

    const taskNames = [];
    const taskTimes = [];

    //Initate the start time of the timer
    function initiateCountdown() 
    {
      var audio = new Audio('programFiles/sfx/startTimer.mp3');
      audio.play();

      //Clear previously running timer
      clearInterval(timerInterval);

      //Change play button to pause button
      switchStartStop(true);

      //Get current time to set as reference point
      var startpoint = new Date().getTime();

      //Ignore values in textboxes if timer is paused
      if (paused == true) {
        paused = false;
        timerInterval = setInterval(function () { countDown(savedTime, startpoint) }, 100);
      }
      else {
        for (var i = 0; i < numSubTasks; i++) {

          //Get time to set to from input
          var minutesInput = document.getElementById("taskTime" + i.toString(10));
          var taskInput = document.getElementById("taskName" + i.toString(10));

          taskTimes[i] = 0;

          if (i != 0) {
            taskTimes[i] = taskTimes[i - 1];
          }

          taskNames[i] = taskInput.value;

          //Set time to 0 if none is specified
          if (minutesInput.value != "" && minutesInput.className != "taskTime-complete")
            taskTimes[i] += JSON.parse(minutesInput.value);
        }

        //Calculate total time based of hours minutes and seconds 
        var totalOffset = taskTimes[numSubTasks - 1] * 60000;

        //Initate countdown function from specified time
        if (totalOffset > 0) {
          originalTime = totalOffset;
          savedTime = totalOffset;
          timerInterval = setInterval(function () { countDown(totalOffset, startpoint) }, 100);

        //Display first task name in textbox
        var taskText = document.getElementById('taskName');
        taskText.innerHTML = taskNames[currentTask];
        }
        else //Initiate countdown function from last set time if no time is specified
        {
          displayStatusText("No time entered!", 3);

          //Change button to 'start'
          var mainButton = document.getElementById("playPauseButton")
          mainButton.innerHTML = "Start";
          mainButton.onclick = function () {initiateCountdown()};
        }
      }
    }

    //Pause the countdown at current point
    function pauseCountdown()
    {
      var audio = new Audio('programFiles/sfx/pauseTimer.mp3');
      audio.play();
      clearInterval(timerInterval);
      savedTime = currentTime;
      paused = true;

      //Save current stopwatch time
      stopwatchOffset = stopwatchTime;

      switchStartStop(false);
    }

    //Reset the countdown back to the originally specified time
    function resetCountdown() {
      var audio = new Audio('programFiles/sfx/resetTimer.mp3');
      audio.play();
      clearInterval(timerInterval);

      for (var i = 0; i < numSubTasks; i++) {
        document.getElementById("taskName" + i).className = "taskName-not-started";
        document.getElementById("taskTime" + i).className = "taskTime-not-started";
      }

      savedTime = originalTime;
      currentTask = 0;

      //Reset current stopwatch time
      stopwatchOffset = 0;

      var startpoint = new Date().getTime();
      countDown(originalTime, startpoint);

      //Change button to 'start'
      switchStartStop(false);
    }

    // Update count down each second
    function countDown(offset, startpoint) {
      // Update date and time to reference against original time
      var now = new Date().getTime();

      // Find the distance between now and reference date, adding in offset to count down from
      var distance = ((startpoint + offset) - now);
      currentTime = distance;

      var elapsedTime = (originalTime/60000) - (currentTime/60000);
      stopwatchTime = (now - startpoint) + stopwatchOffset;

      //Mark a task as complete if it finished
      if(elapsedTime > taskTimes[currentTask])
      {
        var audio = new Audio('programFiles/sfx/subtaskComplete.mp3');
        audio.play();

        document.getElementById("taskTime" + currentTask).className="taskTime-complete";
        document.getElementById("taskName" + currentTask).className="taskName-complete";

        currentTask++;
        var taskText = document.getElementById("taskName");
        taskText.innerHTML = taskNames[currentTask];

        if(document.getElementById("statusText").innerHTML == "-")
        displayStatusText("TASK COMPLETE", 1);
      }

      // Calculate hours, minutes and seconds
      var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
      var seconds = Math.floor((distance % (1000 * 60)) / 1000);

      // Display the result to screen
      document.getElementById("counter").innerHTML = hours + ":"
        + minutes + ":" + seconds;

      // Notify user if countdown complete
      if (distance < 0) {
        //Play finish sound
        var audio = new Audio('programFiles/sfx/allTasksComplete.mp3');
        audio.play();

        clearInterval(timerInterval);
        document.getElementById("counter").innerHTML = "00:00:00";
        document.getElementById("taskName").innerHTML = "-";
        displayStatusText("COMPLETE", 3);
        resetCountdown()
      }

      //Update the stopwatch time
      updateStopwatch(stopwatchTime)
    }


    //Add another subtask
    function addTask(name, time) {
      var audio = new Audio('programFiles/sfx/mouse-click.mp3');
      audio.play();

      numSubTasks++;

      // Retrieve the container tot add sub-tasks to
      var tasksContainer = document.getElementById("tasksContainer");

      // Create two input elements
      var lineBreak = document.createElement("br");
      var taskNameInput = document.createElement("input");
      var mInput = document.createElement("input");
      var taskAdd = document.createElement("button");

      //set id of linebreak
      lineBreak.id = "break" + (numSubTasks.toString(10) - 1);

      //Set type, placeholder and id of taskNameInput
      taskNameInput.type = "Text";
      taskNameInput.placeholder = "Task name";
      taskNameInput.id = "taskName" + (numSubTasks.toString(10) - 1);
      taskNameInput.value = name;

      //Set type, placeholder and id of timer
      mInput.type = "number";
      mInput.placeholder = "Minutes";
      mInput.id = "taskTime" + (numSubTasks.toString(10) - 1);
      mInput.value = time;

      //Unhide button once task is added
      if(numSubTasks == 1)
      {
      document.getElementById("playPauseButton").hidden = false;
      document.getElementById("resetButton").hidden = false;
      document.getElementById("skipButton").hidden = false;
      document.getElementById("addMinuteButton").hidden = false;
      document.getElementById("removeTaskButton").hidden = false;
      }

      tasksContainer.appendChild(lineBreak);
      tasksContainer.appendChild(taskNameInput);
      tasksContainer.appendChild(mInput);

      displayStatusText("TASK ADDED", 1);
    }

    //import subtasks from a csv file
    function importSubTask(csvFile) {
      var originalNumSubTasks = numSubTasks;

      //Remove all previously added tasks
      for (var i = 0; i < originalNumSubTasks; i++) {
        removeTask(i);
      }

      //Reset subTask count to 0
      numSubTasks = 0;

      //Read data in csv file
      let file = csvFile.files[0];
      var reader = new FileReader();
      reader.readAsText(file);

      reader.onload = function (event) {
        var taskData = event.target.result;

        //Split data by each line
        var dataByRow = taskData.split('\n');

        //Split data in each line by commas
        for (var r = 1; r < dataByRow.length - 1; r++) {
          var taskDetails = dataByRow[r].split(',');

          if (taskDetails[0] == "") {
            taskDetails[0] = "Unamed task"
          }

        //Catch error if an empty time is given
        try{
          addTask(taskDetails[0], JSON.parse(taskDetails[1]));
        }
        catch(syntaxError){
          console.log("CAUGHT: Empty time in CSV");
        }
      }
    }
    }

    function removeTask(number) 
    {
      var audio = new Audio('programFiles/sfx/mouse-click.mp3');
      audio.play();
      currentTaskName = document.getElementById("taskName" + number);
      currentTaskTime = document.getElementById("taskTime" + number);
      lineBreak = document.getElementById("break" + number);

      if (currentTaskName != null) {
        currentTaskName.remove();
      }

      if (currentTaskTime != null) {
        currentTaskTime.remove();
      }

      if (lineBreak != null)
        lineBreak.remove();

      numSubTasks--;

      if(numSubTasks == 0)
      {
      document.getElementById("playPauseButton").hidden = true;
      document.getElementById("resetButton").hidden = true;
      document.getElementById("skipButton").hidden = true;
      document.getElementById("addMinuteButton").hidden = true;
      document.getElementById("removeTaskButton").hidden = true;
      }

        displayStatusText("TASK REMOVED", 1);
    }

    function exportSubTasks() {
      var audio = new Audio('programFiles/sfx/mouse-click.mp3');
      audio.play();
      //Create a new variable to store the csv data
      var csvData = "Task name,task time\n";

      //Loop through subTasks and add name and time of each one to csvData seperated by commas
      for (var i = 0; i < numSubTasks; i++) {
        currentTaskName = document.getElementById("taskName" + i).value;
        currentTaskTime = document.getElementById("taskTime" + i).value;
        csvData += currentTaskName + "," + currentTaskTime + "\n";
      }

      //Download the data
      var csvFile = document.createElement('a');
      csvFile.href = 'data:text/csv;charset=utf-8,' + encodeURI(csvData);
      csvFile.target = '_blank';

      //Default name for the csv file is 'task data.csv'
      csvFile.download = 'Task data.csv';
      csvFile.click();

      displayStatusText("TASKS SAVED", 5);
    }

    //Skip the current subtask
    function skipTask() {
      var audio = new Audio('programFiles/sfx/skipTask.mp3');
      audio.play();
      
      if (currentTask < taskTimes.length) {

        //Update total time to the time the next task starts at
        currentTime = (taskTimes[numSubTasks - 1] - taskTimes[currentTask]) * 60000;
        savedTime = currentTime;

        /*  
          Set paused to true and run initiate countdown
          to run countdown from updated time
        */
        paused = true;

        //Save current stopwatch time
        stopwatchOffset = stopwatchTime;

        initiateCountdown();
      }

      displayStatusText("TASK SKIPPED", 1);
    }

    //Extend the current subTask
    function extendTask(extendMinutes) {

      var audio = new Audio('programFiles/sfx/addMin.mp3');
      audio.play();
      var currentTaskTime = 0;

      if (currentTask == 0) {
        currentTaskTime = taskTimes[currentTask];
      }
      else {
        currentTaskTime = taskTimes[currentTask] - taskTimes[currentTask - 1];
      }

      console.log(currentTaskTime);
      //Update the value in the input for the currentSubtask
      document.getElementById("taskTime" + currentTask).value = currentTaskTime + extendMinutes;

      //Save current stopwatch time
      stopwatchOffset = stopwatchTime;

      //Run the countdown with the extra minute added to subtask
      initiateCountdown();

      displayStatusText("TASK EXTENDED BY 1 MINUTE", 1);
    }

    function updateStopwatch(elapsedTime)
    {

      var elapsedTimeDisplay = document.getElementById("elapsedTime");
      var eHours = Math.floor((elapsedTime % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      var eMinutes = Math.floor((elapsedTime % (1000 * 60 * 60)) / (1000 * 60));
      var eSeconds = Math.floor((elapsedTime % (1000 * 60)) / 1000);

      elapsedTimeDisplay.innerHTML = eHours + ":"
        + eMinutes + ":" + eSeconds;
    }

    function displayStatusText(text, seconds)
    {
      clearInterval(statusDisplay);
      document.getElementById("statusText").innerHTML = text;
      statusDisplay = setInterval(function () { clearText(text) }, seconds*1000);
    }

    function clearText(text)
    {
      document.getElementById("statusText").innerHTML = "-";
      clearInterval(statusDisplay);
    }

    function switchStartStop(timerStarted){

      var startButton = document.getElementById("playPauseButton");
      
      if(timerStarted == true)
      {
        startButton.innerHTML = "Pause";
        startButton.onclick = function () {pauseCountdown()};
        startButton.className = "pause-button";
      }
      else
      {
        startButton.innerHTML = "Start";
        startButton.onclick = function () {initiateCountdown()};
        startButton.className = "start-button";
      }
    }
  </script>
</head>

<body>
  <div class="center-div">
    <h1>Meeting timer</h1>
    <div class="timer-container">
      <br>
      <h2 class="main-timer" id="counter">00:00:00</h2>
      <h3 id="taskName">No task</h3>
      <p class="secondary-timer" id="elapsedTime">00:00:00</p>
      <h2 id="statusText" class="accent">-</h2>
    </div>
  
    <div class="tasks-container">
      <div id="tasksContainer" class="center_div">
        <h2>AGENDA</h2>
        <div>
          <button type="button" onclick="addTask('', 0)" id="addTaskButton">Add Task</button>
          <input onchange="importSubTask(this)" type="file" id="csv-file-input" accept=".csv" class="import-csv">
        </div>
        <br>

      </div>
      <button type="button" onclick="initiateCountdown()" id="playPauseButton" hidden class="start-button">Start</button>
      <div class="center-div">
        <button type="button" onclick="resetCountdown()" id="resetButton" hidden>Reset</button>
        <button type="button" onclick="skipTask()" id="skipButton" hidden>Skip</button>
        <button type="button" onclick="extendTask(1)" id="addMinuteButton" hidden>+ 1 min</button>
      </div>
    </div>
    <br>

      <br>
    <div class="center-div">
        <button type="button" onclick="exportSubTasks()">Export Tasks</button>
        <button type="button" onclick="removeTask(numSubTasks-1)" id="removeTaskButton" hidden class="negative">Remove Task</button>
    </div>
  </div>
</body>

</html>